<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GGStandoff WebApp</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* —Ç—É—Ç –≤–∞—à—ñ —Å—Ç–∏–ª—ñ (–∑–∞–ª–∏—à—Ç–µ —è–∫ —î) */
    </style>
</head>
<body>
    <!-- —Ç—É—Ç –≤–∞—à HTML (–∑–∞–ª–∏—à—Ç–µ —è–∫ —î) -->

    <script>
        // ==================== –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø ====================
        // ‚ö†Ô∏è –í–°–¢–ê–í–¢–ï –°–Æ–î–ò –í–ê–® URL –í–Ü–î NGROK
        const API_BASE_URL = 'https://cowardly-vibrionic-tamera.ngrok-free.dev/api';

        // –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ
        let tg = window.Telegram.WebApp;
        let userId = tg.initDataUnsafe.user?.id;
        let userData = null;
        let currentCaseKey = null;
        let selectedCount = 1;
        let casesData = [];

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
        tg.expand();
        tg.ready();

        if (!userId) {
            userId = prompt("–í–≤–µ–¥—ñ—Ç—å –≤–∞—à Telegram ID –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è:", "123456789");
        }

        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–æ—á–∞—Ç–∫–æ–≤–∏—Ö –¥–∞–Ω–∏—Ö
        loadProfile();

        // ==================== –§–£–ù–ö–¶–Ü–á API ====================
        async function apiCall(endpoint, data = {}) {
            data.user_id = userId;
            try {
                const response = await fetch(`${API_BASE_URL}/${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                return { success: false, message: '–ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è –∑ —Å–µ—Ä–≤–µ—Ä–æ–º' };
            }
        }

        // ==================== –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø –ü–†–û–§–Ü–õ–Æ ====================
        async function loadProfile() {
            const data = await apiCall('profile');
            if (data.success) {
                userData = data.profile;
                updateBalanceDisplay(userData.balance);
                loadCasesFromConfig();
            } else {
                showNotification('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å');
            }
        }

        function updateBalanceDisplay(balance) {
            document.getElementById('balanceAmount').innerText = balance;
            document.getElementById('caseDetailBalance').innerText = balance;
        }

        // ==================== –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø –ö–ï–ô–°–Ü–í ====================
        function loadCasesFromConfig() {
            casesData = [
                { key: "Standard Case", name: "‚ö™ –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π –∫–µ–π—Å", price: 100, description: "–ë–∞–∑–æ–≤–∏–π –∫–µ–π—Å –∑—ñ –∑–≤–∏—á–∞–π–Ω–∏–º–∏ —Ç–∞ —Ä—ñ–¥–∫—ñ—Å–Ω–∏–º–∏ —Å–∫—ñ–Ω–∞–º–∏" },
                { key: "Premium Case", name: "üîµ –ü—Ä–µ–º—ñ—É–º –∫–µ–π—Å", price: 500, description: "–ö–µ–π—Å –∑ –≤–∏—â–∏–º–∏ —à–∞–Ω—Å–∞–º–∏ –Ω–∞ –µ–ø—ñ—á–Ω—ñ —Å–∫—ñ–Ω–∏" },
                { key: "Elite Case", name: "üü£ –ï–ª—ñ—Ç–Ω–∏–π –∫–µ–π—Å", price: 1000, description: "–ï–∫—Å–∫–ª—é–∑–∏–≤–Ω–∏–π –∫–µ–π—Å –∑ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—é –≤–∏–±–∏—Ç–∏ –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω—ñ —Å–∫—ñ–Ω–∏" },
                { key: "Ultimate Case", name: "üü† –£–ª—å—Ç–∏–º–∞—Ç –∫–µ–π—Å", price: 2500, description: "–ù–∞–π–∫—Ä–∞—â–∏–π –∫–µ–π—Å –∑ —à–∞–Ω—Å–æ–º –Ω–∞ –∞—Ä–∫–∞–Ω–Ω—ñ —Å–∫—ñ–Ω–∏!" }
            ];
            renderCasesList();
        }

        // ==================== –í–Ü–î–û–ë–†–ê–ñ–ï–ù–ù–Ø –ö–ï–ô–°–Ü–í ====================
        function renderCasesList() {
            const container = document.getElementById('casesList');
            let html = '';
            casesData.forEach(c => {
                html += `
                    <div class="case-item" onclick="selectCase('${c.key}')">
                        <div class="case-name">${c.name}</div>
                        <div class="case-price">üí∞ ${c.price} –º–æ–Ω–µ—Ç</div>
                        <div class="case-description">${c.description}</div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function selectCase(caseKey) {
            currentCaseKey = caseKey;
            const caseData = casesData.find(c => c.key === caseKey);
            document.getElementById('caseDetailName').innerText = caseData.name;
            document.getElementById('caseDetailDesc').innerText = caseData.description;

            const counts = [1, 2, 5, 10];
            let buttonsHtml = '';
            counts.forEach(count => {
                buttonsHtml += `<button class="count-btn ${count === 1 ? 'selected' : ''}" onclick="selectCount(${count})">${count}</button>`;
            });
            document.getElementById('countSelector').innerHTML = buttonsHtml;
            selectedCount = 1;

            hideAllScreens();
            document.getElementById('caseDetailScreen').classList.remove('hidden');
        }

        function selectCount(count) {
            selectedCount = count;
            document.querySelectorAll('.count-btn').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.innerText == count) btn.classList.add('selected');
            });
        }

        // ==================== –í–Ü–î–ö–†–ò–¢–¢–Ø –ö–ï–ô–°–£ ====================
        async function openCase() {
            const caseData = casesData.find(c => c.key === currentCaseKey);
            if (!caseData) return;

            document.getElementById('openCaseBtn').disabled = true;
            document.getElementById('openCaseBtn').innerText = '‚è≥ –í—ñ–¥–∫—Ä–∏—Ç—Ç—è...';

            const result = await apiCall('open_case', {
                case_key: currentCaseKey,
                count: selectedCount
            });

            document.getElementById('openCaseBtn').disabled = false;
            document.getElementById('openCaseBtn').innerText = 'üîì –í—ñ–¥–∫—Ä–∏—Ç–∏';

            if (result.success) {
                if (result.new_balance !== undefined) {
                    updateBalanceDisplay(result.new_balance);
                }
                showResults(result.results, result.total_cost, result.new_balance);
            } else {
                alert(result.message || '–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –∫–µ–π—Å—É');
            }
        }

        function showResults(results, totalCost, newBalance) {
            let html = '';
            results.forEach((r, index) => {
                html += `
                    <div class="result-item">
                        <div style="font-size: 24px;">${r.emoji}</div>
                        <div><strong>${r.skin_name}</strong> (${r.rarity})</div>
                        <div>üÜî ${r.skin_id} | üí∞ –ø—Ä–æ–¥–∞–∂: ${r.sell_price}</div>
                    </div>
                `;
            });
            document.getElementById('resultsList').innerHTML = html;
            document.getElementById('newBalanceResult').innerText = newBalance || '?';

            hideAllScreens();
            document.getElementById('resultScreen').classList.remove('hidden');
        }

        // ==================== –Ü–ù–í–ï–ù–¢–ê–† ====================
        async function showInventory() {
            hideAllScreens();
            document.getElementById('inventoryScreen').classList.remove('hidden');
            document.getElementById('inventoryList').innerHTML = '<div class="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';

            const data = await apiCall('get_inventory');
            if (data.success) {
                renderInventory(data.inventory);
            } else {
                document.getElementById('inventoryList').innerHTML = '<p>–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ–Ω–≤–µ–Ω—Ç–∞—Ä—è</p>';
            }
        }

        function renderInventory(items) {
            const container = document.getElementById('inventoryList');
            if (items.length === 0) {
                container.innerHTML = '<p>–Ü–Ω–≤–µ–Ω—Ç–∞—Ä –ø–æ—Ä–æ–∂–Ω—ñ–π</p>';
                return;
            }
            let html = '';
            items.forEach(item => {
                html += `
                    <div class="inventory-item">
                        <div class="rarity">${item.emoji}</div>
                        <div class="name">${item.skin_name}</div>
                        <div class="price">üí∞ ${item.sell_price}</div>
                        <button class="sell-btn" onclick="sellSkin(${item.id})">–ü—Ä–æ–¥–∞—Ç–∏</button>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        async function sellSkin(skinId) {
            if (!confirm('–ü—Ä–æ–¥–∞—Ç–∏ —Ü–µ–π —Å–∫—ñ–Ω?')) return;
            const result = await apiCall('sell_skin', { skin_id: skinId });
            if (result.success) {
                alert(result.message);
                updateBalanceDisplay(result.new_balance);
                showInventory();
            } else {
                alert(result.message);
            }
        }

        async function sellAllInventory() {
            if (!confirm('–ü—Ä–æ–¥–∞—Ç–∏ –í–°–Ü —Å–∫—ñ–Ω–∏ –∑ —ñ–Ω–≤–µ–Ω—Ç–∞—Ä—è? –¶—é –¥—ñ—é –Ω–µ–º–æ–∂–ª–∏–≤–æ —Å–∫–∞—Å—É–≤–∞—Ç–∏.')) return;
            const result = await apiCall('sell_all');
            if (result.success) {
                alert(result.message);
                updateBalanceDisplay(result.total);
                showInventory();
            } else {
                alert(result.message);
            }
        }

        // ==================== –ü–†–û–§–Ü–õ–¨ ====================
        async function showProfile() {
            hideAllScreens();
            document.getElementById('profileScreen').classList.remove('hidden');
            document.getElementById('profileInfo').innerHTML = '<div class="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';

            const data = await apiCall('profile');
            if (data.success) {
                const p = data.profile;
                let html = `
                    <p><strong>ID:</strong> ${p.user_id}</p>
                    <p><strong>Username:</strong> @${p.username || '–Ω–µ–º–∞—î'}</p>
                    <p><strong>–ë–∞–ª–∞–Ω—Å:</strong> ${p.balance} –º–æ–Ω–µ—Ç</p>
                    <p><strong>–†—ñ–≤–µ–Ω—å:</strong> ${p.level} (XP: ${p.xp}/100)</p>
                    <p><strong>–ó–Ω–∏–∂–∫–∞:</strong> ${p.discount}%</p>
                    <p><strong>–í—ñ–¥–∫—Ä–∏—Ç–æ –∫–µ–π—Å—ñ–≤:</strong> ${p.cases_opened}</p>
                `;
                if (p.most_expensive_skin) {
                    html += `<p><strong>–ù–∞–π–¥–æ—Ä–æ–∂—á–∏–π —Å–∫—ñ–Ω:</strong> ${p.most_expensive_skin.skin_name} (${p.most_expensive_skin.rarity}) - ${p.most_expensive_skin.case_price} –º–æ–Ω–µ—Ç</p>`;
                }
                document.getElementById('profileInfo').innerHTML = html;
            } else {
                document.getElementById('profileInfo').innerHTML = '<p>–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é</p>';
            }
        }

        // ==================== –ú–ê–†–ö–ï–¢, –î–£–ï–õ–Ü, –¢–£–†–ù–Ü–† ====================
        function showMarket() {
            hideAllScreens();
            document.getElementById('marketScreen').classList.remove('hidden');
        }

        function showDuels() {
            hideAllScreens();
            document.getElementById('duelsScreen').classList.remove('hidden');
        }

        function showTournament() {
            hideAllScreens();
            document.getElementById('tournamentScreen').classList.remove('hidden');
        }

        function showCases() {
            hideAllScreens();
            document.getElementById('casesScreen').classList.remove('hidden');
        }

        // ==================== –ù–ê–í–Ü–ì–ê–¶–Ü–Ø ====================
        function goBack() {
            hideAllScreens();
            document.getElementById('mainScreen').classList.remove('hidden');
        }

        function goBackToCases() {
            hideAllScreens();
            document.getElementById('casesScreen').classList.remove('hidden');
        }

        function hideAllScreens() {
            document.getElementById('mainScreen').classList.add('hidden');
            document.getElementById('casesScreen').classList.add('hidden');
            document.getElementById('caseDetailScreen').classList.add('hidden');
            document.getElementById('resultScreen').classList.add('hidden');
            document.getElementById('inventoryScreen').classList.add('hidden');
            document.getElementById('profileScreen').classList.add('hidden');
            document.getElementById('marketScreen').classList.add('hidden');
            document.getElementById('duelsScreen').classList.add('hidden');
            document.getElementById('tournamentScreen').classList.add('hidden');
        }

        function showNotification(msg) {
            alert(msg);
        }
    </script>
</body>
</html>

</html>
